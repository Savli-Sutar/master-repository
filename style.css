
const URL = "https://teachablemachine.withgoogle.com/models/CPn8HY5wC/"; 

let model, webcam, labelContainer, maxPredictions;
let lastDetected = "";

const disposalData = {
    "Plastic": {
        rules: ["‚Ä¢ Empty and rinse the container.", "‚Ä¢ Remove caps and rings.", "‚Ä¢ Squash to save space.", "‚Ä¢ Ensure no liquid is inside."],
        note: "‚ö†Ô∏è Greasy plastic (oil bottles) should go to General Waste."
    },
    "Organic": {
        rules: ["‚Ä¢ Remove plastic stickers from peels.", "‚Ä¢ Drain excess food liquids.", "‚Ä¢ No plastic bags allowed.", "‚Ä¢ Eggshells and coffee grounds are okay."],
        note: "üßÅ Special Case: Greasy cupcake liners belong here!"
    },
    "Paper": {
        rules: ["‚Ä¢ Must be dry and clean.", "‚Ä¢ Remove large staples or tape.", "‚Ä¢ Flatten cardboard boxes.", "‚Ä¢ No shredded paper if possible."],
        note: "‚ö†Ô∏è Greasy pizza boxes or wet paper belong in Organic."
    },
    "Metal": {
        rules: ["‚Ä¢ Rinse food cans thoroughly.", "‚Ä¢ Push lids inside the cans.", "‚Ä¢ Scrunch clean foil into a ball.", "‚Ä¢ Do not include electronics."],
        note: "‚ö†Ô∏è Batteries are e-waste! Do not put them here."
    },
    "Glass": {
        rules: ["‚Ä¢ Rinse jars and remove lids.", "‚Ä¢ Do not break the glass.", "‚Ä¢ Separate by color if possible.", "‚Ä¢ Check for metal neck rings."],
        note: "‚ö†Ô∏è Mirrors and bulbs are NOT recyclable glass."
    }
};

async function init() {
    document.getElementById("webcam-container").innerHTML = "<p style='color:white; padding-top:140px;'>Accessing Camera...</p>";
    
    try {
        model = await tmImage.load(URL + "model.json", URL + "metadata.json");
        maxPredictions = model.getTotalClasses();

        webcam = new tmImage.Webcam(300, 300, true); 
        await webcam.setup(); // request access
        await webcam.play();
        window.requestAnimationFrame(loop);

        document.getElementById("webcam-container").innerHTML = "";
        document.getElementById("webcam-container").appendChild(webcam.canvas);
        labelContainer = document.getElementById("label-container");
    } catch (err) {
        document.getElementById("webcam-container").innerHTML = "<p style='color:red; padding-top:100px;'>Error: Camera Blocked or Link Invalid. Please Allow Camera Access.</p>";
        console.error(err);
    }
}

async function loop() {
    webcam.update();
    await predict();
    window.requestAnimationFrame(loop);
}

async function predict() {
    const prediction = await model.predict(webcam.canvas);
    for (let i = 0; i < maxPredictions; i++) {
        const p = prediction[i];
        if (p.probability > 0.90 && lastDetected !== p.className) {
            lastDetected = p.className;
            showModal(p.className);
            updateBins(p.className);
        }
    }
}

function showModal(type) {
    const data = disposalData[type];
    if (!data) return;
    
    document.getElementById("wasteTitle").innerText = type + " Waste Detected!";
    const list = document.getElementById("disposalList");
    list.innerHTML = "";
    data.rules.forEach(r => {
        let li = document.createElement("li");
        li.innerText = r;
        list.appendChild(li);
    });
    document.getElementById("specialNote").innerText = data.note;
    document.getElementById("disposalModal").style.display = "block";
}

function updateBins(type) {
    const mapping = {"Plastic": 1, "Organic": 2, "Paper": 3, "Metal": 4, "Glass": 5};
    const id = mapping[type];
    if (id) {
        document.getElementById("fill" + id).style.width = "75%";
        document.getElementById("bin" + id).innerText = "AI Status: Level High";
        document.getElementById("bin" + id).style.color = "red";
    }
}

function closeModal() {
    document.getElementById("disposalModal").style.display = "none";
    setTimeout(() => { lastDetected = ""; }, 4000);
}
